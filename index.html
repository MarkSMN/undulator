<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            width: 100vw;
            height: 100vh;
        }
        
        canvas {
            display: block;
        }
        
        body.rotate-mode canvas {
            transform: rotate(-90deg);
            transform-origin: center center;
            position: absolute;
            width: 100vh !important;
            height: 100vw !important;
            top: 50%;
            left: 50%;
            transform-origin: center;
            transform: translate(-50%, -50%) rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Load p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    
    <!-- Script to check for rotation parameter -->
    <script>
        // Check if URL has rotate=true parameter
        const urlParams = new URLSearchParams(window.location.search);
        const shouldRotate = urlParams.get('rotate') === 'true';
        
        // Apply rotation class if needed
        if (shouldRotate) {
            document.body.classList.add('rotate-mode');
        }
    </script>
    
    <!-- Setup rotation handling if needed -->
    <script>
        // Only run this code if rotation is enabled
        if (shouldRotate) {
            // Store original functions
            const originalSetup = window.setup;
            const originalMousePressed = window.mousePressed;
            const originalMouseDragged = window.mouseDragged;
            const originalWindowResized = window.windowResized;
            
            // Override setup function
            window.setup = function() {
                // For a rotated view, use the full window size
                // For portrait mode (vertical TV), we want to use 100% of the width and height
                let canvas = createCanvas(windowHeight, windowWidth);
                
                // Ensure the canvas fills the viewport
                canvas.style('width', '100vh');
                canvas.style('height', '100vw');
                
                // Call your original setup code
                if (typeof originalSetup === 'function') {
                    // Store original windowWidth/windowHeight values
                    const origWidth = windowWidth;
                    const origHeight = windowHeight;
                    
                    // Swap width/height for the duration of the setup call
                    windowWidth = windowHeight;
                    windowHeight = origWidth;
                    
                    originalSetup();
                    
                    // Restore original values
                    windowWidth = origWidth;
                    windowHeight = origHeight;
                } else {
                    // If no original setup, do the basics
                    generateComposition();
                    initializeVortexPoints();
                    createConnections();
                    loop();
                }
            };
            
            // Function to transform mouse coordinates for the rotated canvas
            function transformMouseCoordinates(mouseX, mouseY) {
                const canvas = document.querySelector('canvas');
                const rect = canvas.getBoundingClientRect();
                
                // Calculate relative position within canvas bounding box
                const relX = (mouseX - rect.left) / rect.width;
                const relY = (mouseY - rect.top) / rect.height;
                
                // Map to rotated canvas coordinates
                return {
                    x: height * relY,
                    y: width * (1 - relX)
                };
            }
            
            // Override mouse event handlers
            window.mousePressed = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Call original handler
                const result = originalMousePressed ? originalMousePressed() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                
                return result;
            };
            
            window.mouseDragged = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                const origPMouseX = pmouseX;
                const origPMouseY = pmouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Transform previous mouse position too
                const transformedPrev = transformMouseCoordinates(origPMouseX, origPMouseY);
                pmouseX = transformedPrev.x;
                pmouseY = transformedPrev.y;
                
                // Call original handler
                const result = originalMouseDragged ? originalMouseDragged() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                pmouseX = origPMouseX;
                pmouseY = origPMouseY;
                
                return result;
            };
            
            // Handle window resizing
            window.windowResized = function() {
                // Resize the canvas to fill the viewport
                resizeCanvas(windowHeight, windowWidth);
                
                document.querySelector('canvas').style.width = '100vh';
                document.querySelector('canvas').style.height = '100vw';
                
                // Call original handler if it exists
                if (typeof originalWindowResized === 'function') {
                    // Store original values
                    const origWidth = windowWidth;
                    const origHeight = windowHeight;
                    
                    // Swap for the duration of the call
                    windowWidth = windowHeight;
                    windowHeight = origWidth;
                    
                    originalWindowResized();
                    
                    // Restore original values
                    windowWidth = origWidth;
                    windowHeight = origHeight;
                }
            };
        }
    </script>
    
    <!-- Load your sketch.js file -->
    <script src="sketch.js"></script>
</body>
</html>
