<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000; /* Black background */
        }
        
        /* Improved rotation styles */
        body.rotate-mode {
            background-color: #000;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        body.rotate-mode canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            display: block;
        }
    </style>
</head>
<body>
    <!-- Load p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    
    <!-- Script to check for rotation parameter -->
    <script>
        // Check if URL has rotate=true parameter
        const urlParams = new URLSearchParams(window.location.search);
        const shouldRotate = urlParams.get('rotate') === 'true';
        
        // Apply rotation class if needed
        if (shouldRotate) {
            document.body.classList.add('rotate-mode');
        }
    </script>
    
    <!-- Setup rotation handling if needed -->
    <script>
        // Only run this code if rotation is enabled
        if (shouldRotate) {
            // Store original functions
            const originalSetup = window.setup;
            const originalDraw = window.draw;
            const originalMousePressed = window.mousePressed;
            const originalMouseDragged = window.mouseDragged;
            const originalWindowResized = window.windowResized;
            
            // Override setup function
            window.setup = function() {
                // For a rotated canvas, we swap width and height
                // but maintain the aspect ratio to prevent skewing
                const screenRatio = windowWidth / windowHeight;
                let canvasWidth, canvasHeight;
                
                // If the screen is wider than tall after rotation
                if (screenRatio < 1) {
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                } else {
                    // Scale to fill the screen while maintaining aspect ratio
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                }
                
                let canvas = createCanvas(canvasWidth, canvasHeight);
                
                // Set focus attributes
                canvas.elt.setAttribute('tabindex', '0');
                canvas.elt.style.outline = 'none';
                canvas.elt.addEventListener('click', function() {
                    this.focus();
                });
                
                // Call your original setup code
                if (typeof originalSetup === 'function') {
                    originalSetup();
                } else {
                    // If no original setup, do the basics
                    generateComposition();
                    initializeVortexPoints();
                    createConnections();
                    loop();
                }
            };
            
            // Function to transform mouse coordinates for the rotated canvas
            function transformMouseCoordinates(mouseX, mouseY) {
                const canvas = document.querySelector('canvas');
                const rect = canvas.getBoundingClientRect();
                
                // Calculate center of canvas
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // Get mouse position relative to center
                const relX = mouseX - centerX;
                const relY = mouseY - centerY;
                
                // Rotate 90 degrees clockwise (to compensate for the -90deg canvas rotation)
                const rotatedX = relY;
                const rotatedY = -relX;
                
                // Translate back to canvas coordinates
                return {
                    x: width/2 + rotatedX,
                    y: height/2 + rotatedY
                };
            }
            
            // Override mouse event handlers
            window.mousePressed = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Call original handler
                const result = originalMousePressed ? originalMousePressed() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                
                return result;
            };
            
            window.mouseDragged = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                const origPMouseX = pmouseX;
                const origPMouseY = pmouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Transform previous mouse position too
                const transformedPrev = transformMouseCoordinates(origPMouseX, origPMouseY);
                pmouseX = transformedPrev.x;
                pmouseY = transformedPrev.y;
                
                // Call original handler
                const result = originalMouseDragged ? originalMouseDragged() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                pmouseX = origPMouseX;
                pmouseY = origPMouseY;
                
                return result;
            };
            
            // Handle window resizing
            window.windowResized = function() {
                const screenRatio = windowWidth / windowHeight;
                let canvasWidth, canvasHeight;
                
                // If the screen is wider than tall after rotation
                if (screenRatio < 1) {
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                } else {
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                }
                
                resizeCanvas(canvasWidth, canvasHeight);
                
                // Call original handler if it exists
                if (typeof originalWindowResized === 'function') {
                    originalWindowResized();
                }
            };
        }
    </script>
    
    <!-- Load your sketch.js file -->
    <script src="sketch.js"></script>
</body>
</html>
