<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
        }
        
        /* Default canvas style */
        canvas {
            display: block;
        }
        
        /* Rotated canvas style */
        body.rotate-mode canvas {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Load p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    
    <!-- Script to check for rotation parameter -->
    <script>
        // Check if URL has rotate=true parameter
        const urlParams = new URLSearchParams(window.location.search);
        const shouldRotate = urlParams.get('rotate') === 'true';
        
        // Apply rotation class if needed
        if (shouldRotate) {
            document.body.classList.add('rotate-mode');
        }
    </script>
    
    <!-- Setup rotation handling if needed -->
    <script>
        // Override createCanvas to ensure proper positioning
        const originalCreateCanvas = window.createCanvas;
        window.createCanvas = function() {
            const canvas = originalCreateCanvas.apply(this, arguments);
            // Center canvas by default
            canvas.elt.style.margin = "auto";
            return canvas;
        };

        // Only run this code if rotation is enabled
        if (shouldRotate) {
            // Store original functions
            const originalSetup = window.setup;
            const originalMousePressed = window.mousePressed;
            const originalMouseDragged = window.mouseDragged;
            const originalWindowResized = window.windowResized;
            
            // Override setup function
            window.setup = function() {
                // For a rotated view, use the opposite dimensions
                let canvasWidth, canvasHeight;
                
                // Swap dimensions for rotation
                if (windowWidth > windowHeight) {
                    // Landscape orientation
                    canvasWidth = windowHeight; 
                    canvasHeight = windowWidth;
                } else {
                    // Portrait orientation
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                }
                
                let canvas = createCanvas(canvasWidth, canvasHeight);
                
                // Position the canvas in the center
                canvas.position((windowWidth - canvasWidth) / 2, (windowHeight - canvasHeight) / 2);
                
                // Set focus attributes
                canvas.elt.setAttribute('tabindex', '0');
                canvas.elt.style.outline = 'none';
                canvas.elt.addEventListener('click', function() {
                    this.focus();
                });
                
                // Call original setup code
                if (typeof originalSetup === 'function') {
                    originalSetup();
                } else {
                    // If no original setup, do the basics
                    generateComposition();
                    initializeVortexPoints();
                    createConnections();
                    loop();
                }
            };
            
            // Function to transform mouse coordinates for the rotated canvas
            function transformMouseCoordinates(mouseX, mouseY) {
                const canvas = document.querySelector('canvas');
                const rect = canvas.getBoundingClientRect();
                
                // Get coordinates relative to canvas
                const relX = mouseX - rect.left;
                const relY = mouseY - rect.top;
                
                // Find center of canvas
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                // Calculate position relative to center
                const fromCenterX = relX - centerX;
                const fromCenterY = relY - centerY;
                
                // Rotate 90 degrees clockwise
                const rotatedX = fromCenterY;
                const rotatedY = -fromCenterX;
                
                // Convert back to canvas coordinates
                return {
                    x: centerX + rotatedX,
                    y: centerY + rotatedY
                };
            }
            
            // Override mouse event handlers
            window.mousePressed = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Call original handler
                const result = originalMousePressed ? originalMousePressed() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                
                return result;
            };
            
            window.mouseDragged = function() {
                const transformed = transformMouseCoordinates(mouseX, mouseY);
                
                // Save original values
                const origMouseX = mouseX;
                const origMouseY = mouseY;
                const origPMouseX = pmouseX;
                const origPMouseY = pmouseY;
                
                // Replace with transformed coordinates
                mouseX = transformed.x;
                mouseY = transformed.y;
                
                // Transform previous mouse position too
                const transformedPrev = transformMouseCoordinates(origPMouseX, origPMouseY);
                pmouseX = transformedPrev.x;
                pmouseY = transformedPrev.y;
                
                // Call original handler
                const result = originalMouseDragged ? originalMouseDragged() : true;
                
                // Restore original values
                mouseX = origMouseX;
                mouseY = origMouseY;
                pmouseX = origPMouseX;
                pmouseY = origPMouseY;
                
                return result;
            };
            
            // Handle window resizing
            window.windowResized = function() {
                // Recalculate canvas dimensions
                let canvasWidth, canvasHeight;
                
                // Swap dimensions for rotation
                if (windowWidth > windowHeight) {
                    // Landscape orientation
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                } else {
                    // Portrait orientation
                    canvasWidth = windowHeight;
                    canvasHeight = windowWidth;
                }
                
                // Resize and reposition the canvas
                resizeCanvas(canvasWidth, canvasHeight);
                const canvas = document.querySelector('canvas');
                if (canvas) {
                    canvas.style.position = 'absolute';
                    canvas.style.left = `${(windowWidth - canvasWidth) / 2}px`;
                    canvas.style.top = `${(windowHeight - canvasHeight) / 2}px`;
                }
                
                // Call original handler if it exists
                if (typeof originalWindowResized === 'function') {
                    originalWindowResized();
                }
            };
        }
    </script>
    
    <!-- Load your sketch.js file -->
    <script src="sketch.js"></script>
</body>
</html>
